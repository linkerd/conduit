FROM gcr.io/linkerd-io/base:2017-10-30.01 as fetch

# XXX We must do HTTPS verification here, but we don't yet have certs in this
# container.
RUN (apt-get update && \
    apt-get install -y ca-certificates ; \
    curl -vsLO https://build.l5d.io/linkerd2-proxy/latest.txt ; \
    latest=$(awk '{print $2}' latest.txt) ; \
    latest_sha=$(awk '{print $1}' latest.txt) ; \
    curl -vsLO "https://build.l5d.io/linkerd2-proxy/${latest}" ; \
    sha=$(sha256sum $latest | awk '{print $1}') ; \
    if [ "$sha" != "$latest_sha" ]; then echo "sha mismatch" >&2 ; exit 1 ; fi ; \
    tar -zxvf ${latest} ; \
    mv "${latest%%.tar.gz}/bin/linkerd2-proxy" . )


ARG RUNTIME_IMAGE=gcr.io/linkerd-io/base:2017-10-30.01
FROM $RUNTIME_IMAGE as runtime
COPY --from=fetch linkerd2-proxy /usr/local/bin/linkerd2-proxy
ENV LINKERD2_PROXY_LOG=warn,linkerd2_proxy=info
ENTRYPOINT ["/usr/local/bin/linkerd2-proxy"]
