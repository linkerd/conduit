#!/bin/bash

set -eu

if [ $# -ne 0 ]; then
    echo "no arguments allowed for $(basename $0), given: $@" >&2
    exit 64
fi

bindir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

containers=$(cat <<-END
controller
web
proxy-init
grafana
proxy
END
)

if [ -z "${CONDUIT_SKIP_CLI_CONTAINER:-}" ]; then
  containers=$(printf "$containers\ncli-bin")
fi

if which parallel >/dev/null; then
  cmd="parallel $bindir/docker-build-{}"
else
  printf "Install parallel to speed the build up (brew install parallel)\n" >&2
  cmd="xargs -I{} /bin/sh -c $bindir/docker-build-{}"
fi

echo "$containers" | $cmd
