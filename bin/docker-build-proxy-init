#!/bin/sh

set -eu

if [ $# -ne 0 ]; then
    echo "no arguments allowed for $(basename $0), given: $@" >&2
    exit 64
fi

. bin/_tag.sh

tag="$(head_root_tag )"

output_dir=./target/go/linux_amd64_cgo
mkdir -p ${output_dir}
CGO_ENABLED=0 GOOS=linux go build \
      -installsuffix cgo \
	  -ldflags "-X github.com/runconduit/conduit/pkg/version.Version=${tag}" \
	  -o "${output_dir}/proxy-init" \
      ./proxy-init

bin/docker-build-base >/dev/null
. bin/_docker.sh
docker_build proxy-init $tag proxy-init/Dockerfile
