#!/bin/bash

set -eu

bindir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
rootdir="$( cd $bindir/.. && pwd )"

system=$(uname -s)

if [ "$system" = "Darwin" ]; then
  OS="darwin"
elif [ "$system" = "Linux" ]; then
  OS="linux"
else
  echo "unknown system: $system" >&2
  exit 1
fi

. $bindir/_tag.sh

tag="$(head_root_tag)"
bin="$rootdir/target/cli-${tag}/${OS}/conduit"

# build conduit executable if it does not exist
if [ ! -f $bin ]; then
  CLI_EXPORT=1 CLI_OS="$OS" $bindir/docker-build-cli-bin >/dev/null
fi

for d in $(ls -d $rootdir/target/cli-*) ; do
  if [ -d "$d" ]; then
    if [ "$d" != "$rootdir/target/cli-${tag}" ]; then
      rm -rf "$d"
    fi
  fi
done

exec $bin "$@"
