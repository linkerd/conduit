#!/bin/sh

set -eu

if [ $# -ne 0 ]; then
    echo "no arguments allowed for $(basename $0), given: $@" >&2
    exit 64
fi

. bin/_tag.sh

tag="$(head_root_tag)"

output_dir=./target/go/linux_amd64_cgo
mkdir -p ${output_dir}
for component in \
    destination \
    proxy-api \
    public-api \
    tap \
    telemetry \
    ; do
  CGO_ENABLED=0 GOOS=linux go build \
      -installsuffix cgo \
	  -ldflags "-X github.com/runconduit/conduit/pkg/version.Version=${tag}" \
	  -o "${output_dir}/$component" \
	  "./controller/cmd/$component"
done

bin/docker-build-base > /dev/null
. bin/_docker.sh
docker_build controller $tag controller/Dockerfile
