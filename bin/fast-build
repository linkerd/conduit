#!/bin/bash

set -eu

if [[ "${1:-}" = "--no-dep" ]]; then
dep_ensure=
else
dep_ensure=1
fi

cd "$(pwd -P)"

# Builds CLI binary for current platform only and outside docker to speed up things. Suitable for local development.

bindir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
rootdir="$( cd $bindir/.. && pwd )"
. $bindir/_tag.sh

LINKERD_SKIP_CLI_CONTAINER=1 $bindir/docker-build
current_platform=$(uname)
host_platform="windows"
if [ "${current_platform}" = 'Darwin' ]; then
    host_platform="darwin"
elif [ "${current_platform}" = 'Linux' ]; then
    host_platform="linux"
fi

(
    cd $rootdir
    if [ ! -z ${dep_ensure} ]; then
      $bindir/dep ensure -vendor-only -v
    fi
    target="target/cli/${host_platform}/linkerd"
    CGO_ENABLED=0 go build -installsuffix cgo -o $target -ldflags "-s -w -X github.com/linkerd/linkerd2/pkg/version.Version=$($bindir/root-tag)" ./cli
    echo "$target"
)
